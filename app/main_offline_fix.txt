    // Start auth initialization immediately
    initializeAuth();

    // Add timeout for offline scenarios - if Firebase doesn't respond in 3 seconds, show login
    const authTimeout = setTimeout(() => {
      if (!authStateLoaded) {
        log.debug('â±ï¸ AUTH TIMEOUT: Firebase took too long (likely offline), showing login');
        setAuthStateLoaded(true);
        setSplashFinished(true);
        setAppState('login');
      }
    }, 3000);

    // Set up Firebase listener for auth state changes - this is the primary auth handler
    const unsubscribe = onAuthStateChanged(auth, async (firebaseUser) => {
      log.debug('ðŸ” AUTH STATE CHANGE - User:', firebaseUser?.email || 'null');

      // Clear timeout since Firebase responded
      clearTimeout(authTimeout);

      // Mark Firebase as initialized once the first auth state change fires
      if (!firebaseInitialized) {
        log.debug('ðŸ”¥ Firebase auth initialized');
        setFirebaseInitialized(true);
      }

      if (firebaseUser) {
        log.debug('ðŸ” AUTH CHANGE: User logged in, checking onboarding');
        setUser(firebaseUser);
        setAuthStateLoaded(true);
        setSplashFinished(true);
        await handleDashboardNavigation(firebaseUser);
      } else {
        log.debug('ðŸ” AUTH CHANGE: User logged out, checking demo users');
        const demoUser = await demoRestoreUser() || demoGetCurrentUser();
        if (demoUser) {
          setUser(demoUser as unknown as FirebaseUser);
          setAuthStateLoaded(true);
          setSplashFinished(true);
          setAppState('dashboard');
        } else {
          setUser(null);
          setAuthStateLoaded(true);
          setSplashFinished(true);
          setAppState('login');
        }
      }
    });

    // Clean up listener and timeout on unmount
    return () => {
      clearTimeout(authTimeout);
      unsubscribe();
    };
  }, []); // Remove dependencies to run once on mount
